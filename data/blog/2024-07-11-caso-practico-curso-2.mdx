---
title: Caso pr√°ctico curso Especialista en Inteligencia Artificial - D√≠as 2 y 3
date: '2024-07-11'
tags: ['aprendizajes', 'inteligencia artificial', 'curso especialista IA']
draft: false
summary: Este es el segundo de varios art√≠culos en los que detallo como defino y desarrollo el caso pr√°ctico para el curso de Especialista en Inteligencia Artificial que estoy realizando.
---

<TOCInline toc={props.toc} />


## Introducci√≥n
En el dia de hoy me he dedicado a preparar el entorno para desarrollar la aplicaci√≥n. Como quiero que esto se pueda desarrollar f√°cilmente en cualquier sistema y gestionar las dependencias sin mucha complicaci√≥n, voy a utilizar virtualenv de Python.
Ahora, lo primero que voy a hacer es definir la estructura del proyecto.

## Estructura del proyecto
```bash
/path/del/proyecto
|-- app.py
|-- modelo_entrenamiento.py # Aqu√≠ entrenamos el modelo para que procese las im√°genes y almacene las codificaciones
|-- requirements.txt 
|-- face_encodings.pkl # Este archivo almacena las codificaciones despues de entrenar el modelo
|-- credenciales.json # Credenciales para acceder a Google Sheets
|-- templates/
|   `-- index.html # P√°gina HTML para la interfaz de la app Flask
|-- imagenes/
|   |-- imagen1.jpg # Imagenes de rostros para entrenar el modelo
|   |-- imagen2.jpg
|   `-- ...
```
## Creamos y activamos un entorno virtual de Python
Asumo que tienes Python y Visrtualenv instalados en tu ordenador, de no ser as√≠, deber√°s de hacerlo primero. Comento tambien que los comandos para activar y desactivar un entorno virtual de Python, var√≠an seg√∫n el sistema operativo que utilices [En este enlace](https://python.land/virtual-environments/virtualenv) tienes las distintas opciones. Yo lo he desarrollado con MacOS. Utilizo por defecto la versi√≥n 3 de Python que viene instalada por defecto.

```bash
# Creamos el entorno

python3 -m venv venv 

# Lo activamos

source venv/bin/activate/```

## Instalamos las dependencias
Instalamos las dependencias que definimos en el art√≠culo anterior:

```bash
pip install flask opencv-python opencv-python-headless dlib face_recognition gspread google-auth google-auth-oauthlib google-auth-httplib2
```

Aqu√≠ empez√≥ mi calvario que ocup√≥ todo mi dia (y parte del tercer dia de desarrollo del proyecto).
Lo bueno del problema es que me suced√≠a tanto en MacOS como en Windows, con o sin WSL. As√≠ que t√©cnicamente el problema es persistente en distintas plataformas. Curiosamente es un problema que no sucede desarrollando sobre un contenedor de Docker, pero como el plan siempre fue desarrollar primero en un entorno local y luego desplegar el contenedor, me volv√≠ loco intentando encontrar una soluci√≥n.

## El maldito CMake de pip est√° roto
[CMake](https://es.wikipedia.org/wiki/CMake) es una herramienta para empaquetar software, entre otras cosas. En nuestro caso, es una dependencia de `dlib` (que es necesario para utilizar `face_recognition`), asi que al instalar `dlib` instala tambi√©n Cmake. Al intentar instalar el paquete con `, nos da el siguiente error (Aqu√≠ por ejemplo lo intent√© instalar en Windows).

```shell
Collecting dlib
  Using cached dlib-19.24.4.tar.gz (3.3 MB)
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
Building wheels for collected packages: dlib
  Building wheel for dlib (pyproject.toml) ... error
  error: subprocess-exited-with-error

Building wheel for dlib (pyproject.toml) did not run successfully.
  ‚îÇ exit code: 1
  ‚ï∞‚îÄ> [14 lines of output]
      <string>:210: SyntaxWarning: invalid escape sequence '\('
      <string>:211: SyntaxWarning: invalid escape sequence '\('
      <string>:212: SyntaxWarning: invalid escape sequence '\('
      running bdist_wheel
      running build
      running build_ext
      Traceback (most recent call last):
        File "<frozen runpy>", line 198, in _run_module_as_main
        File "<frozen runpy>", line 88, in _run_code
        File "D:\Dev\app-reconocimiento-facial\venv\Scripts\cmake.exe\__main__.py", line 4, in <module>
      ModuleNotFoundError: No module named 'cmake'

      ERROR: CMake must be installed to build dlib

      [end of output]

  note: This error originates from a subprocess, and is likely not a problem with pip.
  ERROR: Failed building wheel for dlib
```

Lo primero que hice es comprobar si Cmake est√° instalado en el entorno virtual:

```shell
(venv) PS D:\Dev\app-reconocimiento-facial> python -m pip install cmake
Requirement already satisfied: cmake in d:\Dev\dev\app-reconocimiento-facial\venv\lib\site-packages (3.29.3
```

A partir de aqu√≠ empez√≥ la odisea de intentar solucionarlo. Como he dicho, desplegu√© incluso un contenedor de Docker, donde no tenia estos problemas. Lo primero que le√≠ es que se tenia que instalar CMake a nivel del sistema, no del entorno virtual. Eso no ayud√≥. Despu√©s he intentado mil trucos, he jugado con versiones espec√≠ficas de los paquetes, he hecho de todo y he fallado una y otra vez. 
Finalmente encontr√© una entrada en Stack Overflow (que desgraciadamente no he encontrado m√°s) donde indicaban que el problema reside en el paquete de dlib de pip, que no funciona correctamente. Esto me llev√≥ a un Bug report en el repositorio de dlib donde sugerian compilarlo nosotros mismos dentro del entorno virtual. 

Algunos de estos pasos seran diferentes para Windows. Aqu√≠ detallo como lo he hecho en MacOS (asumo que ser√° lo mismo en Linux).

```shell
# Instalamos cmake en el entorno virtual
pip install cmake

# Comprobamos que esta Cmake
which cmake

# Exportamos el path
export CMAKE=$(which cmake)

# Comprobamos que funciona
cmake --version

# Dentro de la carpeta del entorno, nos bajamos dlib y lo compilamos
git clone https://github.com/davisking/dlib.git
cd dlib
mkdir build
cd build
cmake ..
cmake ‚Äìbuild .

cd .. # De vuelta a la carpeta dlib

# Lo instalamos. Esto lleva un rato
python3 setup.py install

# Comprobamos que tenemos dlib funcionando
python3 -c "import dlib; print(dlib.__version__)"

```

Con esto consegu√≠ que finalmente funcionara dlib. ¬°¬°¬°La verdad que me ha costado vida y media!!! üéâü•≥

## Fin del segundo dia (y parte del tercero)
Como he mencionado al principio, solucionar este problema me ha costado algo m√°s de un d√≠a. Creo que he pecado un poco (bastante) de novato. Aunque durante a√±os he hecho desarrollo (principalmente frontend) hay cosas que aun me cuestan mucho solucionar. Que, cuando un paquete no funcione, lo intentes compilar t√∫ mismo, es de primero de manual de programador üòÖ. La cuesti√≥n es que he sabido solucionar el problema, y de paso he aprendido cosas nuevas, que estoy seguro que me servir√°n en el futuro. ¬°A por el dia 3!

¬°Ah! No olvides echarle un vistazo al repositorio: https://github.com/jhmarina/app-reconocimiento-facial 
